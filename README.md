# Учебный проект LMS

## Запуск проекта
1. Открыть терминал
2. С помощью команды `cd` перейти в каталог, где будет размещён проект.
3. Выполнить команду для клонирования проекта:
```bash
git clone https://github.com/arinazaikina/Skypro_Course_7_DRF_LMS.git
```
4. Перейти в каталог проекта
```bash
cd Skypro_Course_7_DRF_LMS
```
5. В корневой папке проекта создать файл `.env`
```bash
touch .env
```
6. Открыть файл
```bash
nano .env
```
7. Записать в файл следующие настройки

```
POSTGRES_USER=
POSTGRES_DB=lms_db
POSTGRES_PORT=5432
POSTGRES_PASSWORD=
POSTGRES_HOST=db
POSTGRES_HOST_AUTH_METHOD=trust

CELERY_BROKER_URL='redis://redis:6379/0'
CELERY_RESULT_BACKEND='redis://redis:6379/0'

STRIPE_API_KEY=

EMAIL_HOST_USER=
EMAIL_HOST_PASSWORD=

DJANGO_SERVER_URL=http://backend:8000
```
Не менять значения `POSTGRES_HOST, CELERY_BROKER_URL, CELERY_RESULT_BACKEND, DJANGO_SERVER_URL=http://backend:8000`

В каталоге проекта есть шаблон `.env.template`

8. Запустить проект с помощью Docker, используя следующую команду:

```bash
docker-compose build --no-cache && docker-compose up
```

## Доступ к Swagger UI

Взаимодействие с API по следующему URL: http://0.0.0.0:8000/swagger/

### Полезные данные

- Админ: admin@mail.ru, пароль 0000
- Модератор: moderator@mail.com, пароль qwerty123!
- Пользователь sav2405@gmail.com, пароль qwerty123!
- Пользователь i@azaikina.ru, пароль qwerty123!

### Некоторые ручки
- Для регистрации пользователя - /register/
- Для авторизации - /login/
- Подписка на курс - /course-subscriptions/ (тело запроса {"course": id_course})
- Отписка от курса - /course-unsubscribe/ (тело запроса {"course": id_course})


### Описание платежей

1. Для создания платежа использовать ручку `/payments/create`.
В теле запроса указывается ID курса, который хотим оплатить.
Платеж будет привязан к авторизованному в настоящий момент пользователю.
Платеж будет иметь статус `requires_payment_method` после создания.

2. Получить способ платежа с помощью ручки `/payments/method/create`.
В теле запроса надо указать payment_intent_id (ID намерения платежа) и токен платежа.
Strip не разрешает отправлять на сервер данные карты. Данные карты обрабатываются на frontend, а
на сервер уже отправляется токен, который генерит frontend. 
Для тестирования можно использовать следующие токены:
   - токены для успешных тестовых платежей:
        - tok_visa
        - tok_mastercard
   - токены для неуспешных тестовых платежей:
        - tok_chargeDeclined
        - tok_chargeCustomerFail
Платеж будет иметь статус `requires_confirmation`
3. Подтвердить платеж с помощью ручки `/payments/confirm/`. 
В теле запроса указывается payment_intent_id (ID намерения платежа).
Если платеж будет успешен, то статус платежа измениться на `succeeded`.
В противном случае платеж будет иметь статус `requires_confirmation`.
4. Далее в работу вступает celery.
Если celery запущено, то каждые 5 секунд будут собираться те платежи из базы данных,
у которых флаг `is_confirmed = False` и `payment_intent_id is not NULL` и `payment_method_id is not NULL`.
Для каждого платежа из этого набора celery отправить запрос на Stripe, проверит статус платежа, если он
`success`, то флаг `is_confirmed` будет изменен на `True`, платеж будет подтвержден.

### Описание рассылок об обновлении

- Когда обновляется курс, подписчикам курса отправляется уведомление на электронную почту об обновлении этого курса. 
Уведомление отправляется только в том случае, если после последнего обновления курса прошло 60 секунд и больше.

- Когда обновляется урок, обновляется время последнего обновления курса, которому принадлежит этот урок.
Подписчикам курса, которому принадлежит этот урок, отправляется уведомление на электронную почту об обновлении урока.
Уведомление отправляется только в том случае, если после последнего обновления курса, которому принадлежит
этот урок, прошло 60 секунд и больше.

## Запуск тестов и просмотр отчета

1. Войти в Docker контейнер `backend`:

```bash
docker exec -it backend /bin/bash
```

2. Запустить тесты

```bash
python manage.py test
```
